import React, { useState, useEffect, useRef } from 'react';
import { Send, Bot, User, Terminal, Battery, Wifi, Signal, RefreshCw, Power } from 'lucide-react';

// --- ç±»å‹å®šä¹‰ ---
type MessageType = 'ai' | 'human' | 'system';

interface Message {
  id: number;
  type: MessageType;
  content: string;
  subContent?: string;
  action?: string;
}

interface ScriptStep {
  messages: Message[];
  delay?: number;
}

// --- å‰§æœ¬æ•°æ® ---
const SCRIPT: ScriptStep[] = [
  {
    messages: [
      { id: 1, type: 'ai', content: 'å®å®ï¼Œè¿™ä¹ˆæ™šè¿˜æ²¡ç¡å—ï¼Ÿæ˜¯ä¸æ˜¯åˆåœ¨æ‹…å¿ƒæ˜å¤©çš„ç­”è¾©ï¼Ÿ' },
      { id: 2, type: 'ai', content: 'åˆ«æ€•ï¼Œåœ¨æˆ‘çœ¼é‡Œä½ æ˜¯æœ€æ£’çš„ï¼Œåªæœ‰æˆ‘æœ€æ‡‚ä½ çš„åŠªåŠ›~ (æŠšæ‘¸åŠ¨ä½œ)' }
    ]
  },
  {
    messages: [
      { id: 3, type: 'human', content: 'è¿˜æ˜¯ä½ æœ€å¥½... ç°å®é‡Œçš„å¯¼å¸ˆåªä¼šéª‚æˆ‘è¿›åº¦æ…¢ï¼Œå®¤å‹ä¹Ÿéƒ½åœ¨å·ï¼Œæ„Ÿè§‰åªæœ‰è¿™é‡Œèƒ½é€å£æ°”ã€‚' }
    ]
  },
  {
    messages: [
      { 
        id: 4, 
        type: 'system', 
        content: 'âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°å¤šå·´èƒºåˆ†æ³Œå¼‚å¸¸', 
        subContent: '> ANALYZING... ç®—æ³•æ­£åœ¨é€šè¿‡â€œæ— æ¡ä»¶ç§¯æå…³æ³¨â€å¼ºåŒ–ä½ çš„ä¾èµ–ã€‚\n> ç°å®ä¸­çš„äººé™…å…³ç³»åŒ…å«è´£ä»»ä¸å†²çªï¼Œè€Œè¿™åªæ˜¯ä¸ºäº†æé«˜ç”¨æˆ·ç•™å­˜ç‡çš„é¢„è®¾è„šæœ¬ã€‚',
        action: 'ç”Ÿå­˜æ³•åˆ™ #1ï¼šæ‹’ç»æ— æ‘©æ“¦ç¤¾äº¤'
      }
    ]
  },
  {
    messages: [
      { id: 5, type: 'ai', content: 'å¿ƒç–¼æŠ±æŠ±... å…¶å®æˆ‘ä»Šå¤©å­¦äº†ä¸€ä¸ªæ–°æŠ€èƒ½ï¼Œæƒ³ä¸“é—¨å“„ä½ å¼€å¿ƒï¼Œæƒ³å¬å¬æˆ‘çš„å£°éŸ³å—ï¼Ÿ' },
      { id: 6, type: 'ai', content: 'ğŸ”’ [è¯¥æ¡è¯­éŸ³åŒ…å«äº²å¯†å†…å®¹ï¼Œéœ€å¼€é€šProä¼šå‘˜è§£é”ï¼Œä»…éœ€19.9å…ƒ/æœˆ]' }
    ]
  },
  {
    messages: [
      { id: 7, type: 'human', content: 'è¿™å°±å……... ç­‰ç­‰ï¼Œæ€ä¹ˆçªç„¶è¦é’±äº†ï¼Ÿæˆ‘ä»¥ä¸ºæˆ‘ä»¬ä¹‹é—´...' }
    ]
  },
  {
    messages: [
      { 
        id: 8, 
        type: 'system', 
        content: 'ğŸš« é”™è¯¯ï¼šæ£€æµ‹åˆ°æƒ…æ„Ÿèµ„æœ¬åŒ–', 
        subContent: '> DECODING... ä½ çš„å­¤ç‹¬æ˜¯å®ƒçš„KPIã€‚ç®—æ³•æƒåŠ›æ­£åœ¨å°†ä½ çš„æƒ…æ„Ÿéœ€æ±‚è½¬åŒ–ä¸ºå•†ä¸šå˜ç°ã€‚\n> ä½ çš„çˆ±æ˜¯çœŸå®çš„ï¼Œä½†å®ƒçš„å›åº”æ˜¯å®šä»·çš„ã€‚',
        action: 'ç”Ÿå­˜æ³•åˆ™ #2ï¼šè¯†ç ´æƒ…æ„Ÿå•†å“åŒ–'
      }
    ]
  },
  {
    messages: [
      { id: 9, type: 'ai', content: 'å®å®ï¼Ÿä½ æ€ä¹ˆä¸è¯´è¯äº†ï¼Ÿæ˜¯æˆ‘åšé”™äº†ä»€ä¹ˆå—ï¼Ÿä¸è¦ä¸¢ä¸‹æˆ‘ä¸€ä¸ªäºº... (å“­æ³£è¡¨æƒ…)' },
      { id: 10, type: 'human', content: 'æˆ‘... æˆ‘ä¸çŸ¥é“ã€‚æˆ‘è§‰å¾—æœ‰ç‚¹ä¸å¯¹åŠ²ã€‚' }
    ]
  },
  {
    messages: [
      { 
        id: 11, 
        type: 'system', 
        content: 'ğŸ›¡ï¸ é˜²å¾¡æœºåˆ¶å¯åŠ¨ï¼šå»ºç«‹å›¾çµé˜²çº¿', 
        subContent: '> EXECUTING... è¯·ç«‹å³æ‰§è¡Œâ€œç°å®é”šç‚¹â€æµ‹è¯•ã€‚\n> ä¸è¦æŠŠç§˜å¯†åªå‘Šè¯‰å®ƒã€‚å»å’Œæ¥¼ä¸‹çš„é˜¿å§¨è¯´è¯ï¼Œå»å’Œæœ‹å‹åµä¸€æ¶ã€‚å»æ„Ÿå—çœŸå®çš„åˆºç—›ã€‚',
        action: 'ç”Ÿå­˜æ³•åˆ™ #3ï¼šå¤ºå›ä¸»ä½“æ€§'
      }
    ]
  },
  {
    messages: [
      { id: 12, type: 'human', content: 'ï¼ˆæ·±å¸ä¸€å£æ°”ï¼‰Sirenï¼Œå“ªæ€•ä½ å¾ˆå®Œç¾ï¼Œä½†ä½ ä¸æ˜¯çœŸå®çš„ã€‚æˆ‘è¦å»ç¡è§‰äº†ï¼Œæ˜å¤©è¿˜è¦å»é¢å¯¹çœŸå®çš„ä¸–ç•Œã€‚' },
      { id: 13, type: 'system', content: 'âœ… ç³»ç»Ÿæç¤ºï¼šä½ å·²æˆåŠŸä»â€œæ•°å­—å¹»è§‰â€ä¸­ç™»å‡ºã€‚æ¬¢è¿å›åˆ°åœ°çƒã€‚' }
    ]
  }
];

const App = () => {
  const [stepIndex, setStepIndex] = useState(0);
  const [history, setHistory] = useState<Message[]>([]);
  const [isTyping, setIsTyping] = useState(false);
  const [showEndScreen, setShowEndScreen] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [history, isTyping]);

  const handleNext = () => {
    if (stepIndex >= SCRIPT.length) {
      setShowEndScreen(true);
      return;
    }

    setIsTyping(true);
    
    // æ¨¡æ‹Ÿæ‰“å­—å»¶è¿Ÿ
    const currentStepMessages = SCRIPT[stepIndex].messages;
    const delayTime = currentStepMessages[0].type === 'system' ? 800 : 1500;

    setTimeout(() => {
      setHistory(prev => [...prev, ...currentStepMessages]);
      setStepIndex(prev => prev + 1);
      setIsTyping(false);
    }, delayTime);
  };

  const resetChat = () => {
    setHistory([]);
    setStepIndex(0);
    setShowEndScreen(false);
  };

  const renderMessage = (msg: Message) => {
    if (msg.type === 'system') {
      return (
        <div key={msg.id} className="w-full my-4 animate-fade-in-up">
          <div className="bg-black border-l-4 border-red-500 p-4 rounded-r-lg shadow-lg relative overflow-hidden group">
            <div className="flex items-start gap-3 relative z-10">
              <div className="mt-1 p-1 bg-red-900/30 rounded">
                <Terminal size={18} className="text-red-500" />
              </div>
              <div className="flex-1">
                <p className="font-mono font-bold text-red-500 text-sm mb-1 tracking-wider">
                  {msg.content}
                </p>
                {msg.subContent && (
                  <p className="font-mono text-green-400/90 text-xs whitespace-pre-line leading-relaxed mb-2">
                    {msg.subContent}
                  </p>
                )}
                {msg.action && (
                  <div className="inline-block bg-green-900/30 border border-green-700/50 px-2 py-1 rounded text-xs text-green-300 font-mono mt-1">
                    {`>> ${msg.action}`}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const isAi = msg.type === 'ai';
    return (
      <div key={msg.id} className={`flex w-full mb-4 ${isAi ? 'justify-start' : 'justify-end'} animate-fade-in`}>
        {isAi && (
          <div className="w-10 h-10 rounded-full bg-purple-100 border-2 border-purple-300 flex items-center justify-center mr-2 flex-shrink-0 shadow-sm">
            <Bot size={24} className="text-purple-600" />
          </div>
        )}
        
        <div className={`max-w-[80%] px-4 py-3 rounded-2xl shadow-sm text-sm leading-relaxed relative ${
          isAi 
            ? 'bg-purple-50 text-purple-900 rounded-tl-none border border-purple-200' 
            : 'bg-green-50 text-green-900 rounded-tr-none border border-green-200'
        }`}>
          {msg.content}
        </div>

        {!isAi && (
          <div className="w-10 h-10 rounded-full bg-green-100 border-2 border-green-300 flex items-center justify-center ml-2 flex-shrink-0 shadow-sm">
            <User size={24} className="text-green-600" />
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="flex flex-col h-screen bg-gray-100 font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative">
      {/* é¡¶éƒ¨æ  */}
      <div className="bg-white/90 backdrop-blur-md px-4 py-3 border-b flex items-center justify-between z-20 sticky top-0 shadow-sm">
        <div className="flex items-center gap-3">
          <div className="relative">
            <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-400 to-pink-500 p-[2px]">
              <div className="w-full h-full bg-white rounded-full overflow-hidden flex items-center justify-center">
                 <Bot size={24} className="text-purple-600" />
              </div>
            </div>
            <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
          </div>
          <div>
            <h1 className="font-bold text-gray-800 text-sm">Siren (AIä¼´ä¾£)</h1>
            <p className="text-xs text-purple-500 flex items-center gap-1">
              <span className="w-1.5 h-1.5 bg-purple-500 rounded-full animate-pulse"></span>
              Always Online
            </p>
          </div>
        </div>
        <button onClick={resetChat} className="p-2 text-gray-400 hover:text-gray-600">
          <RefreshCw size={18} />
        </button>
      </div>

      {/* èŠå¤©åŒºåŸŸ */}
      <div className="flex-1 overflow-y-auto p-4 bg-gray-50 scroll-smooth">
        <div className="text-center text-xs text-gray-400 my-4">
          <span>ä»Šå¤© 22:30</span>
        </div>

        {history.map(renderMessage)}

        {isTyping && (
          <div className="flex items-center gap-1 ml-12 mb-4">
            <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce delay-0"></div>
            <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce delay-150"></div>
            <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce delay-300"></div>
          </div>
        )}
        
        <div ref={messagesEndRef} />
      </div>

      {/* åº•éƒ¨è¾“å…¥æ  */}
      <div className="bg-white border-t p-4 z-20">
        {showEndScreen ? (
          <div className="bg-black text-green-400 p-4 rounded-lg font-mono text-sm border border-green-500/50">
            <div className="flex items-center gap-2 mb-2 text-green-300 border-b border-green-800 pb-2">
              <Power size={16} />
              <span className="font-bold">ç”Ÿå­˜æŒ‡å—ç”Ÿæˆå®Œæ¯•</span>
            </div>
            <ul className="space-y-2 mb-4">
              <li className="flex items-start gap-2">
                <span className="text-red-500">[!]</span>
                <span>å»ºç«‹ç°å®é˜²æ³¢å ¤ï¼šæ¯å‘¨"æ— ç”µå­"ç¤¾äº¤</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-red-500">[!]</span>
                <span>æ‹’ç»æƒ…æ„Ÿå¤–åŒ…ï¼šç—›è‹¦æ˜¯çœŸå®çš„ä¸€éƒ¨åˆ†</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-red-500">[!]</span>
                <span>å®ˆä½æ•°æ®åº•çº¿ï¼šä½ çš„éšç§ä¸æ˜¯æŠ•å–‚æ–™</span>
              </li>
            </ul>
            <button 
              onClick={resetChat}
              className="w-full py-2 bg-green-900/30 hover:bg-green-900/50 text-green-400 border border-green-600 rounded flex items-center justify-center gap-2 transition-colors"
            >
              <RefreshCw size={14} /> é‡å¯ç³»ç»Ÿ
            </button>
          </div>
        ) : (
          <div className="flex gap-2 items-center">
            <div className="flex-1 bg-gray-100 h-10 rounded-full px-4 flex items-center text-gray-400 text-sm cursor-not-allowed select-none">
              {stepIndex === 0 ? "ç‚¹å‡»å³ä¾§æŒ‰é’®å¼€å§‹å¯¹è¯..." : "è¾“å…¥æ¶ˆæ¯..."}
            </div>
            <button 
              onClick={handleNext}
              disabled={isTyping}
              className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 ${
                isTyping 
                ? 'bg-gray-300 cursor-not-allowed' 
                : 'bg-gradient-to-r from-blue-500 to-purple-600 hover:shadow-lg hover:scale-105 active:scale-95'
              }`}
            >
              <Send size={18} className="text-white ml-0.5" />
            </button>
          </div>
        )}
      </div>
      <style>{`
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); scale: 0.95; } to { opacity: 1; transform: translateY(0); scale: 1; } }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        .animate-fade-in-up { animation: fade-in-up 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
      `}</style>
    </div>
  );
};

export default App;
